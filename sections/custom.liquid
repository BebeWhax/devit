<style>
  
</style>

<div class="outfit-builder-section page-width">
  <div class="outfit-builder-container">
    {% if section.settings.image %}
    <div class="outfit-builder-image">
      <img src="{{ section.settings.image | img_url: 'master' }}" alt="{{ section.settings.image.alt | escape }}"
        loading="lazy" width="{{ section.settings.image.width }}" height="{{ section.settings.image.height }}">
    </div>
    {% endif %}

    <div class="outfit-builder-products">
      <div class="swiper outfit-swiper">
        <div class="swiper-wrapper">
          {% for block in section.blocks %}
          {% if block.settings.product != blank %}
          {% assign product = block.settings.product %}
          {% assign first_variant = product.selected_or_first_available_variant %}

          <div class="swiper-slide outfit-product-card" data-block-id="{{ block.id }}">
            <div class="product-image">
              {% if product.featured_image %}
              <img src="{{ product.featured_image | img_url }}" alt="{{ product.featured_image.alt | escape }}"
                loading="lazy">
              {% endif %}
            </div>

            <div class="product-details">
              <div class="product-header">
                <h3 class="product-title">{{ product.title }}</h3>
                <div class="product-price">
                  {% if product.compare_at_price > product.price %}
                  <span class="price-sale">{{ product.price | money }}</span>
                  <span class="price-compare">{{ product.compare_at_price | money }}</span>
                  {% else %}
                  <span class="price-regular">{{ product.price | money }}</span>
                  {% endif %}
                </div>
              </div>

              {% if product.description != blank %}
              <p class="product-description">{{ product.description | strip_html | truncate: 60 }}</p>
              {% endif %}

              <div class="product-actions">
                {% if product.has_only_default_variant %}
                <div class="variant-selector">
                  <span class="variant-label">One Size</span>
                </div>
                {% else %}
                <div class="variant-selector">
                  <select class="variant-select" data-product-id="{{ product.id }}"
                    aria-label="Select variant for {{ product.title }}">
                    {% for variant in product.variants %}
                    <option value="{{ variant.id }}" {% if variant==first_variant %}selected{% endif %} {% unless
                      variant.available %}disabled{% endunless %}>
                      {{ variant.title }}
                      {% unless variant.available %} - Sold Out{% endunless %}
                    </option>
                    {% endfor %}
                  </select>
                </div>
                {% endif %}

                <button class="add-to-cart-btn" data-variant-id="{{ first_variant.id }}"
                  data-product-id="{{ product.id }}" {% unless first_variant.available %}disabled{% endunless %}
                  tabindex="0" aria-label="Add {{ product.title }} to cart">
                  {% if first_variant.available %}
                  Add to bag
                  {% else %}
                  Sold Out
                  {% endif %}
                </button>
              </div>
            </div>
          </div>
          {% endif %}
          {% endfor %}
        </div>

        <div class="swiper-pagination"></div>
      </div>
    </div>
  </div>
</div>

<script>
  (function ($) {
    'use strict';

    $(document).ready(function () {
      let swiper;
      function initSwiper() {
        if (window.innerWidth < 750 && !swiper) {
          swiper = new Swiper('.outfit-swiper', {
            slidesPerView: 1,
            spaceBetween: 20,
            pagination: {
              el: '.swiper-pagination',
              clickable: true,
            },
            navigation: {
              nextEl: '.swiper-button-next',
              prevEl: '.swiper-button-prev',
            },
          });
        } else if (window.innerWidth >= 750 && swiper) {
          swiper.destroy(true, true);
          swiper = null;
        }
      }
      initSwiper();
      $(window).on('resize', initSwiper);

      $('.variant-select').on('change', function () {
        const $card = $(this).closest('.outfit-product-card');
        const $addBtn = $card.find('.add-to-cart-btn');
        const $selectedOption = $(this).find('option:selected');

        $addBtn.attr('data-variant-id', $(this).val());

        if ($selectedOption.is(':disabled')) {
          $addBtn.prop('disabled', true).text('Sold Out');
        } else {
          $addBtn.prop('disabled', false).text('Add to bag');
        }
      });

      $('.add-to-cart-btn').on('click', function (e) {
        e.preventDefault();

        const $btn = $(this);

        if ($btn.prop('disabled')) {
          return;
        }

        const variantId = $btn.data('variant-id');
        const originalText = $btn.text();

        $btn.addClass('loading').prop('disabled', true);

        $.ajax({
          url: '/cart/add.js',
          method: 'POST',
          dataType: 'json',
          contentType: 'application/json',
          data: JSON.stringify({
            id: variantId,
            quantity: 1
          }),
          success: function (data) {
            console.log('Product added to cart:', data);

            if (typeof theme !== 'undefined' && theme.cartUpdateAll) {
              theme.cartUpdateAll();
            }

            $(document).trigger('cart:updated', data);

            $.ajax({
              url: '/cart.js',
              method: 'GET',
              dataType: 'json',
              success: function (cart) {
                console.log('Cart updated:', cart);

                // Update cart count in theme
                if ($('.cart-count, .cart-count-bubble').length) {
                  $('.cart-count, .cart-count-bubble').text(cart.item_count);
                }

                if ($('cart-drawer').length) {
                  $('cart-drawer')[0].open();
                } else if ($('.js-drawer-open-right, [data-cart-drawer]').length) {
                  $('.js-drawer-open-right, [data-cart-drawer]').first().trigger('click');
                }
              }
            });

            $btn.removeClass('loading')
              .text('Added!')
              .addClass('success');

            setTimeout(function () {
              $btn.text(originalText)
                .removeClass('success')
                .prop('disabled', false);
            }, 2000);
          },
          error: function (xhr, status, error) {
            console.error('Error adding to cart:', error);
            console.error('Response:', xhr.responseText);

            let errorMessage = 'Error';

            try {
              const response = JSON.parse(xhr.responseText);
              if (response.description) {
                errorMessage = response.description;
              }
            } catch (e) {
              // Use default error message
            }

            $btn.removeClass('loading')
              .text(errorMessage)
              .addClass('error');

            setTimeout(function () {
              $btn.text(originalText)
                .removeClass('error')
                .prop('disabled', false);
            }, 3000);
          }
        });
      });

      const $focusableElements = $('.variant-select, .add-to-cart-btn');

      $focusableElements.each(function () {
        $(this).attr('tabindex', '0');
      });

      $focusableElements.on('keydown', function (e) {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          $(this).trigger('click');
        }
      });

      const styleSheet = document.createElement('style');
      styleSheet.textContent = `
        .add-to-cart-btn.success {
          background: #4caf50 !important;
        }
        .add-to-cart-btn.error {
          background: #f44336 !important;
        }
      `;
      document.head.appendChild(styleSheet);
    });
  })(jQuery);
</script>

{% schema %}
{
"name": "Outfit Builder",
"settings": [
  {
  "type": "image_picker",
  "id": "image",
  "label": "Outfit Image"
  }
],
"blocks": [
  {
    "type": "product",
    "name": "Product",
    "settings": [
        {
        "type": "product",
        "id": "product",
        "label": "Select Product"
        }
      ]
  }
],
  "presets": [
    {
      "name": "Outfit Builder",
      "blocks": []
    }
  ]
}
{% endschema %}